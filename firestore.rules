rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is signed in
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Users collection - authenticated users can read/write their own data
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == userId;
    }
    
    // Questions collection - anyone can read, authenticated users can create
    match /questions/{questionId} {
      allow read: if true;  // Anyone can read questions
      allow create: if isSignedIn();  // Must be logged in to create
      allow update: if isSignedIn();  // Can update (for upvotes, answer counts)
      allow delete: if isSignedIn() && request.auth.uid == resource.data.author.id;
    }
    
    // Answers collection - anyone can read, authenticated users can create
    match /answers/{answerId} {
      allow read: if true;  // Anyone can read answers
      allow create: if isSignedIn();  // Must be logged in to create
      allow update: if isSignedIn();  // Can update (for upvotes)
      allow delete: if isSignedIn() && request.auth.uid == resource.data.author.id;
    }
    
    // Votes collection - for tracking upvotes
    match /votes/{voteId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }
    
    // Appointments collection - users can only access their own appointments
    match /appointments/{appointmentId} {
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }
  }
}
